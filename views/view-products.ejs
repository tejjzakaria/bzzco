<!doctype html>

<html lang="en" class="layout-navbar-fixed layout-menu-fixed layout-compact" dir="ltr" data-skin="default"
    data-bs-theme="light" data-assets-path="/assets/" data-template="vertical-menu-template">

<head>
    <meta charset="utf-8" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
    <meta name="robots" content="noindex, nofollow" />
    <title>Products - Bzz Co.</title>

    <meta name="description" content="" />
    <%- include("layout/header") %>




</head>

<body>
    <!-- Layout wrapper -->
    <div class="layout-wrapper layout-content-navbar">
        <div class="layout-container">
            <!-- Menu -->

            <%- include("layout/sidebar") %>

                <div class="menu-mobile-toggler d-xl-none rounded-1">
                    <a href="javascript:void(0);"
                        class="layout-menu-toggle menu-link text-large text-bg-secondary p-2 rounded-1">
                        <i class="ri ri-menu-line icon-base"></i>
                        <i class="ri ri-arrow-right-s-line icon-base"></i>
                    </a>
                </div>
                <!-- / Menu -->

                <!-- Layout container -->
                <div class="layout-page">
                    <!-- Navbar -->

                    <%- include("layout/header") %>

                        <!-- / Navbar -->

                        <!-- Content wrapper -->
                        <div class="content-wrapper">
                            <!-- Content -->
                            <div class="container-xxl flex-grow-1 container-p-y">
                                <!-- Product List Widget -->
                                <div class="card mb-6">
                                    <div class="card-widget-separator-wrapper">
                                        <div class="card-body card-widget-separator">
                                            <div class="row gy-4 gy-sm-1">
                                                <div class="col-sm-6 col-lg-3">
                                                    <div
                                                        class="d-flex justify-content-between align-items-start card-widget-1 border-end pb-4 pb-sm-0">
                                                        <div>
                                                            <p class="mb-1">In-store Sales</p>
                                                            <h4 class="mb-1">$5,345.43</h4>
                                                            <p class="mb-0">
                                                                <span class="me-2">5k orders</span><span
                                                                    class="badge rounded-pill bg-label-success">+5.7%</span>
                                                            </p>
                                                        </div>
                                                        <div class="avatar me-sm-6">
                                                            <span class="avatar-initial rounded-3 text-heading">
                                                                <i class="icon-base ri ri-home-6-line icon-28px"></i>
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <hr class="d-none d-sm-block d-lg-none me-6" />
                                                </div>
                                                <div class="col-sm-6 col-lg-3">
                                                    <div
                                                        class="d-flex justify-content-between align-items-start card-widget-2 border-end pb-4 pb-sm-0">
                                                        <div>
                                                            <p class="mb-1">Website Sales</p>
                                                            <h4 class="mb-1">$674,347.12</h4>
                                                            <p class="mb-0">
                                                                <span class="me-2">21k orders</span><span
                                                                    class="badge rounded-pill bg-label-success">+12.4%</span>
                                                            </p>
                                                        </div>
                                                        <div class="avatar me-lg-6">
                                                            <span class="avatar-initial rounded-3 text-heading">
                                                                <i class="icon-base ri ri-computer-line icon-28px"></i>
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <hr class="d-none d-sm-block d-lg-none" />
                                                </div>
                                                <div class="col-sm-6 col-lg-3">
                                                    <div
                                                        class="d-flex justify-content-between align-items-start border-end pb-4 pb-sm-0 card-widget-3">
                                                        <div>
                                                            <p class="mb-1">Discount</p>
                                                            <h4 class="mb-1">$14,235.12</h4>
                                                            <p class="mb-0">6k orders</p>
                                                        </div>
                                                        <div class="avatar me-sm-6">
                                                            <span class="avatar-initial rounded-3 text-heading">
                                                                <i class="icon-base ri ri-gift-line icon-28px"></i>
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-sm-6 col-lg-3">
                                                    <div class="d-flex justify-content-between align-items-start">
                                                        <div>
                                                            <p class="mb-1">Affiliate</p>
                                                            <h4 class="mb-1">$8,345.23</h4>
                                                            <p class="mb-0">
                                                                <span class="me-2">150 orders</span><span
                                                                    class="badge rounded-pill bg-label-danger">-3.5%</span>
                                                            </p>
                                                        </div>
                                                        <div class="avatar">
                                                            <span class="avatar-initial rounded-3 text-heading">
                                                                <i
                                                                    class="icon-base ri ri-money-dollar-circle-line icon-28px"></i>
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Product List Table -->
                                <div class="card">
                                    
                                    <!-- Updated table structure and style to match app-ecommerce-product-list.js -->
                                    <div class="card-datatable table-responsive position-relative">
                                        <table class="table datatables-products" id="productsTable">
                                            <thead>
                                                <tr>
                                                    <th></th>
                                                    <th>Product</th>
                                                    <th>Stock</th>
                                                    <th>SKU</th>
                                                    <th>Price</th>
                                                    <th>Qty</th>
                                                    <th>Status</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Empty initially - DataTables will populate -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Product Details Modal -->
                                <div class="modal fade" id="productDetailsModal" tabindex="-1"
                                    aria-labelledby="productDetailsModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-xl">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="productDetailsModalLabel">Product Details
                                                </h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body" id="productDetailsContent">
                                                <!-- Product details will be loaded here -->
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary"
                                                    data-bs-dismiss="modal">Close</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- / Content -->

                            <!-- Footer -->
                            <%- include("layout/footer") %>
                                <!-- / Footer -->

                                <div class="content-backdrop fade"></div>
                        </div>
                        <!-- Content wrapper -->
                </div>
                <!-- / Layout page -->
        </div>

        <!-- Overlay -->
        <div class="layout-overlay layout-menu-toggle"></div>

        <!-- Drag Target Area To SlideIn Menu On Small Screens -->
        <div class="drag-target"></div>
    </div>
    <!-- / Layout wrapper -->

    <!-- Core JS -->
    <script src="/assets/vendor/libs/jquery/jquery.js"></script>
    <script src="/assets/vendor/libs/popper/popper.js"></script>
    <script src="/assets/vendor/js/bootstrap.js"></script>
    <script src="/assets/vendor/libs/node-waves/node-waves.js"></script>
    <script src="/assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>
    <script src="/assets/vendor/libs/hammer/hammer.js"></script>
    <script src="/assets/vendor/libs/i18n/i18n.js"></script>
    <script src="/assets/vendor/libs/typeahead-js/typeahead.js"></script>
    <script src="/assets/vendor/js/menu.js"></script>

    <!-- Vendors JS -->
    <script src="/assets/vendor/libs/select2/select2.js"></script>
    <script src="/assets/vendor/libs/sweetalert2/sweetalert2.js"></script>

    <!-- Main JS -->
    <script src="/assets/js/main.js"></script>

    <!-- Include DataTables JS -->
    <script src="/assets/vendor/libs/datatables-bs5/datatables-bootstrap5.js"></script>

    <!-- Page specific JS -->
    <script>
        // First, let's test if jQuery is loaded
        console.log('jQuery version:', typeof $ !== 'undefined' ? $.fn.jquery : 'jQuery not loaded');
        console.log('Document ready test...');

        $(document).ready(function () {
            console.log('jQuery document ready fired!');
            
            // Add debugging
            console.log('Table HTML columns:', $('#productsTable thead th').length);

            // Check if DataTable is already initialized and destroy it
            if ($.fn.DataTable.isDataTable('#productsTable')) {
                console.log('Destroying existing DataTable...');
                $('#productsTable').DataTable().destroy();
                // Clear only tbody, keep thead intact
                $('#productsTable tbody').empty();
            }

            // Wait a bit to ensure no other scripts are interfering
            setTimeout(function() {
                console.log('Initializing DataTable...');
                
                // Simple DataTable initialization
                var table = $('#productsTable').DataTable({
                    processing: true,
                    serverSide: false,
                    destroy: true, // Allow reinitialization
                    ajax: {
                        url: '/api/products',
                        dataSrc: 'data'
                    },
                columns: [
                    { 
                        data: null,
                        orderable: false,
                        render: function(data, type, row) {
                            return `<input type="checkbox" class="form-check-input" value="${row.productSku}">`;
                        }
                    },
                    { 
                        data: 'productTitle',
                        render: function(data, type, row) {
                            const imageHtml = row.images && row.images.length > 0 
                                ? `<img src="${row.images[0]}" style="width: 40px; height: 40px; object-fit: cover;" class="rounded me-2">` 
                                : `<div class="bg-light rounded d-inline-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;"><i class="ri ri-image-line"></i></div>`;
                            
                            return `<div class="d-flex align-items-center">
                                        ${imageHtml}
                                        <div>
                                            <div class="fw-medium">${data}</div>
                                            <small class="text-muted">${row.category}</small>
                                        </div>
                                    </div>`;
                        }
                    },
                    { 
                        data: 'inStock',
                        render: function(data) {
                            return data ? '<span class="alert alert-success"><i class="ri ri-check-line"></i></span>' : '<span class="alert alert-danger"><i class="ri ri-close-line"></i> Out of Stock</span>';
                        }
                    },
                    { data: 'productSku' },
                    { 
                        data: 'productPrice',
                        render: function(data) {
                            return `$${parseFloat(data || 0).toFixed(2)}`;
                        }
                    },
                    { data: 'quantity' },
                    { 
                        data: 'status',
                        render: function(data) {
                            return data === 'Published' ? '<span class="badge bg-success">Published</span>' : '<span class="badge bg-danger">Inactive</span>';
                        }
                    },
                    { 
                        data: '_id',
                        orderable: false,
                        render: function(data) {
                            return `<div class="d-flex gap-2">
                                        <button class="btn btn-sm btn-outline-primary" onclick="viewProduct('${data}')" title="View">
                                            <i class="ri ri-eye-line"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="editProduct('${data}')" title="Edit">
                                            <i class="ri ri-edit-line"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct('${data}')" title="Delete">
                                            <i class="ri ri-delete-bin-line"></i>
                                        </button>
                                    </div>`;
                        }
                    }
                ],
                pageLength: 10,
                responsive: true,
                order: [[1, 'asc']], // Sort by Product column (index 1)
                language: {
                    emptyTable: 'No products found',
                    loadingRecords: 'Loading products...',
                    processing: 'Processing...'
                }                });
                
                // Add debugging for column count
                console.log('DataTable columns configured:', table.columns().count());
            }, 100); // Wait 100ms to avoid conflicts
        });

        // Manual table population removed - using DataTable AJAX instead

        // Fixed the viewProduct function to handle errors properly
        function viewProduct(productId) {
            fetch(`/api/products/${productId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        displayProductDetails(data.product);
                        $('#productDetailsModal').modal('show');
                    } else {
                        Swal.fire('Error', data.message || 'Failed to load product details', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire('Error', error.message || 'Failed to load product details', 'error');
                });
        }

        function editProduct(productId) {
            window.location.href = `/edit-product/${productId}`;
        }

        function deleteProduct(productId) {
            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/api/products/${productId}`, {
                        method: 'DELETE'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                title: 'Deleted!',
                                text: 'Product has been deleted successfully.',
                                icon: 'success',
                                timer: 2000,
                                showConfirmButton: false
                            }).then(() => {
                                // Reload the DataTable instead of the entire page
                                $('#productsTable').DataTable().ajax.reload();
                            });
                        } else {
                            Swal.fire({
                                title: 'Error!',
                                text: data.message || 'Failed to delete product',
                                icon: 'error'
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Delete error:', error);
                        Swal.fire({
                            title: 'Error!',
                            text: 'Failed to delete product. Please try again.',
                            icon: 'error'
                        });
                    });
                }
            });
        }

        // Updated the view popup style for better appearance
        function displayProductDetails(product) {
            const formatDate = (date) => date ? new Date(date).toLocaleDateString() : 'N/A';
            const formatPrice = (price) => price ? '$' + parseFloat(price).toFixed(2) : 'N/A';

            const imagesHtml = product.images && product.images.length > 0
                ? product.images.map(img => `<img src="${img}" class="rounded border me-2 mb-2" style="width: 120px; height: 120px; object-fit: cover;">`).join('')
                : '<span class="text-muted">No images uploaded</span>';

            const variantsHtml = product.variants && product.variants.length > 0
                ? product.variants.map(v => `<span class="badge bg-primary me-1">${v.option}: ${v.value}</span>`).join('')
                : '<span class="text-muted">No variants</span>';

            const tagsHtml = product.tags && product.tags.length > 0
                ? product.tags.map(tag => `<span class="badge bg-secondary me-1">${tag}</span>`).join('')
                : '<span class="text-muted">No tags</span>';

            document.getElementById('productDetailsContent').innerHTML = `
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="fw-bold mb-3">Basic Information</h5>
                            <table class="table table-striped">
                                <tr><th>Title:</th><td>${product.productTitle}</td></tr>
                                <tr><th>Category:</th><td>${product.category}</td></tr>
                                <tr><th>SKU:</th><td>${product.productSku}</td></tr>
                                <tr><th>Price:</th><td>${formatPrice(product.productPrice)}</td></tr>
                                <tr><th>Stock:</th><td>${product.inStock ? 'In Stock' : 'Out of Stock'}</td></tr>
                                <tr><th>Created At:</th><td>${formatDate(product.createdAt)}</td></tr>
                                <tr><th>Description:</th><td>${product.description || 'No description available'}</td></tr>
                                <tr><th>Manufacturer:</th><td>${product.manufacturer || 'N/A'}</td></tr>
                                <tr><th>Dimensions:</th><td>${product.dimensions || 'N/A'}</td></tr>
                                <tr><th>Weight:</th><td>${product.weight || 'N/A'}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h5 class="fw-bold mb-3">Images</h5>
                            <div>${imagesHtml}</div>

                            <h5 class="fw-bold mt-4 mb-3">Variants</h5>
                            <div>${variantsHtml}</div>

                            <h5 class="fw-bold mt-4 mb-3">Tags</h5>
                            <div>${tagsHtml}</div>
                        </div>
                    </div>
                </div>
            `;
        }


    </script>
</body>

</html>